---
title: "us_higher_ed"
output: html_document
name: Diamond Andy, Lily Gates, Mia Leandri, Colin Thompson
date: 04/20/2025
---
-----------------------------------------------
# PROJECT OVERVIEW
-----------------------------------------------
# Description of Project
Exploring the differences between American research colleges and universities through data visualization.

## Research Question/Topic
1. Descriptive and Comparative Question
**How do different tiered American research colleges and universities compare in terms of location, admissions, academic offerings, doctoral degrees awarded, and other institutional characteristics?**

2. Analytical and Inferential Question
**How do other institutional characteristics, besides financial expenditures, predict or correlate with research designation tiers among American colleges and universities?**

## Data and Research Sources
`carnegie_spending_doctorate_awards`
(See c`arnegie_research_activity_desig_factsheet.pdf` for more info)
* School
* Location (City, State)
* Classification (R1, R2, Other) — From 2021 and 2025
* Expenses (2021, 2022, 2023)
* Research Doctorates Awarded (2020, 2021, 2022)

`carnegie_classification_stats`
(See `carnegie_variable_descr_flowchart.pdf` for more info)
* School
    * Filtering main school if applicable (e.g., UMBC, UMD, UMES all are “University of Maryland” sub schools)
* Location (City, State, residential or not)
* Public or private (non-profit, for-profit)
* Description of types of degree programs offered
* Enrollment information
* Classification on tier (R1, R2, Other)

-----------------------------------------------
# CODE BEGINS
-----------------------------------------------

# Installing Packages
Note: Only have to do 1 time
```{r}
#install.packages("patchwork")
```


# Importing Libraries
```{r}
library(tidyverse)
library(readr)
library(tidyr)
library(dplyr)
library(lubridate)  # for Datetime formatting
library(stringr)  # for extracting URL
library(patchwork)  # for putting multiple graphs on one fig
```

# Reading in Data
```{r}
classification_stats <- read_csv("carnegie_classification_stats - CLEAN.csv")

spending_doctorate_awards <- read_csv("carnegie_spending_doctorate_awards - CLEAN.csv")
```

# Preview and Summarize Data
```{r}
#head(classification_stats)
colnames(classification_stats)
summary(classification_stats)

head(spending_doctorate_awards)
colnames(spending_doctorate_awards)
summary(spending_doctorate_awards)
```

------------------------------------------------------
# CREATING DATAFRAMES
------------------------------------------------------

# Convert Both Imported CSVs to Dataframes
```{r}
classification_df <- data.frame(classification_stats)
class(classification_df)

spending_df <- data.frame(spending_doctorate_awards)
class(spending_df)
```

```{r}
# Confirming column names on what to join by
colnames(classification_df)
colnames(spending_df)
```

# Combine Both into Single Dataframe
# Note: has name.x and name.y
- This is because the `classification_df` and `spending_df` both have "name" but it was raising an error: "Error: unexpected symbol" for that column when trying to do a full join

```{r}
# Perform full join on 'unitid'
combined_df <- full_join(classification_df, spending_df, by = "unitid")

# Confirm join and notice duplicate column names
colnames(combined_df)
```

------------------------------------------------------
# CLEANING DATA
------------------------------------------------------

# Debugging - Checking for Duplicate Values in Duplicate Column Names
(name, city, state each have x and y values)
The `.x` refers to the column coming from `classification_df`
The `.y` refers to the column coming from `spending_df`

```{r}
# Duplicate School Names (there are 12)
combined_df %>%
  filter(name.x != name.y) %>%
  select(unitid, name.x, name.y)

# Duplicate City Names (there is 1, 'Des Moines' and 'West Des Moines')
combined_df %>%
  filter(city.x != city.y ) %>%
  select(unitid, city.x, city.y)

# Duplicate State Names (there are no duplicates)
combined_df %>%
  filter(state.x != state.y) %>%
  select(unitid, state.x, state.y)

# Create a new dataframe for mismatched rows
mismatched <- combined_df %>%
  filter(name.x != name.y | city.x != city.y | state.x != state.y) %>%
  select(unitid, name.x, name.y, city.x, city.y, state.x, state.y)

# View the mismatched rows
print(mismatched)

```

# Cleaning Data -- Fill any missing values with "NA"
```{r}
# Function to replace NULL with NA

replace_null_with_na <- function(x) {
  if (is.list(x)) {
    # Apply recursively if it's a list (to handle nested data frames)
    return(lapply(x, replace_null_with_na))
  } else if (is.null(x)) {
    return(NA)  # Replace NULL with NA
  } else {
    return(x)  # Otherwise, return the value unchanged
  }
}

# Use it to apply to a data frame
combined_df_na <- combined_df %>%
  mutate(across(everything(), replace_null_with_na))

# View the result
summary(combined_df_na)
```

# Debugging - Checking which columns have missing values (NA)
Note:
`spec_name` may have many values and that is okay, it is optional
(e.g., University of Maryland, College Park would have "College Park" as the spec_name", but John's Hopkins only has one campus, so there is no "main campus" or any other special name)

```{r}
# Display a table of the count of missing values (NAs) per column
missing_data <- combined_df_na %>% 
  summarise(across(everything(), ~ sum(is.na(.)))) %>%
  gather(key = "column_name", value = "NAs")

print(missing_data)
```

------------------------------------------------------
# VISUALIZATIONS
------------------------------------------------------

# Visualization Name (e.g., Research Expenses from 2020 to 2023)
  * Description about what variables you are measuring
  * ~3 sentence summary about visualization

# Number of Institutions by Research Classification 2021
# By Diamond
This bar graph represents the number of institutions that were categorized under the 2021 Carnegie research classification tier. Comparing how many universities fall into each group and highlights the overall distribution of research in U.S. Institutions. This visualization also helps emphasize the tiers that are less common.
```{r}
combined_df_na %>%
  count(classific_2021) %>%
  ggplot(aes(x = classific_2021, y = n, fill = classific_2021)) +
  geom_bar(stat = "identity") +
  labs(title = "Number of Institutions by Research Classification (2021)",
       x = "Classification", y = "Number of Institutions") +
  theme_minimal()

```

# Research Activity Designations (2025)
# By Lily
This graph visualizes the raw count and relative distribution of institutions by their research activity designation in 2025. The categories displayed include "Research Colleges and Universities", "Research 1", and "Research 2". Data excludes institutions without a research designation.

The graph shows the both the raw count and relative distribution of institutions across three research activity categories: Research Colleges and Universities (RCA), Research 1 (R1), and Research 2 (R2).
  - RCA institutions spend at least $2.5 million on research annually but do not meet the criteria for R1 or R2.
  - R1 institutions spend at least $50 million on research and produce at least 70 research doctorates annually
  - R2 institutions spend at least $5 million and produce at least 20 research doctorates.

```{r}
library(ggplot2)
library(dplyr)
library(patchwork)

# Prepare the data and drop NA
plot_data <- combined_df_na %>%
  filter(!is.na(research_tier_2025)) %>%
  mutate(
    research_tier_2025 = factor(
      research_tier_2025,
      levels = c("Research Colleges and Universities",
                 "Research 1: Very High Research Spending and Doctorate Production", 
                 "Research 2: High Research Spending and Doctorate Production")
    )
  ) %>%
  count(research_tier_2025) %>%
  mutate(percentage = n / sum(n) * 100)  # Calculate percentage for pie chart

# Raw count bar plot
raw_count_plot <- ggplot(plot_data, aes(x = research_tier_2025, y = n)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(
    x = "Research Activity Designation",
    y = "Raw Count"
  ) +
  theme_minimal() +
  scale_x_discrete(labels = c(
    "Research Colleges and Universities" = "Research Colleges\nand Universities", 
    "Research 1: Very High Research Spending and Doctorate Production" = "R1", 
    "Research 2: High Research Spending and Doctorate Production" = "R2"
  ))

# Proportional bar plot (percentage)
proportional_plot <- ggplot(plot_data, aes(x = research_tier_2025, y = percentage)) +
  geom_bar(stat = "identity", fill = "lightblue") +
  labs(
    x = "Research Activity Designation",
    y = "Proportion (%)"
  ) +
  theme_minimal() +
  scale_x_discrete(labels = c(
    "Research Colleges and Universities" = "Research Colleges\nand Universities", 
    "Research 1: Very High Research Spending and Doctorate Production" = "R1", 
    "Research 2: High Research Spending and Doctorate Production" = "R2"
  ))

# Combine the two plots and add a single title, subtitle, and caption for the whole figure
combined_plot <- raw_count_plot + proportional_plot + 
  plot_layout(guides = 'collect') +
  plot_annotation(
    title = "Raw Count and Proportion of Institutions by Research Activity Designation (2025)",
    subtitle = "Excludes institutions without a research designation",
    caption = "Note: 'Research Colleges and Universities' are research-focused but do not meet R1 or R2 criteria"
  )

# Print the combined plot
combined_plot

```

